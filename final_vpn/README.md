## 🧪 技术实现细节

### 核心模块

#### 1. `vpn_core::asymmetric` - 非对称加密

- Ed25519 数字签名算法
- 服务端身份认证
- 密钥生成和管理

#### 2. `vpn_core::symmetric` - 对称加密

- 使用 ChaCha20-Poly1305 AEAD
- 自动生成随机 Nonce（12 字节）
- 输出格式：`[Nonce 12B] + [密文 + MAC 16B]`

#### 3. `vpn_core::handshake` - 握手协议

- **混合密钥交换**（X25519 + ML-KEM-768）
- X25519 临时密钥对生成
- ML-KEM-768 密钥封装和解封装
- ECDH 共享密钥计算
- BLAKE3 混合密钥派生函数：`KDF(ECDH || ML-KEM || PSK)`
- Ed25519 签名集成
- Bincode 消息序列化

#### 4. `vpn_core::local_tun` - TUN 设备

- 跨平台 TUN 设备创建
- 自动配置 IP 和路由
- 处理 macOS/Linux 数据包头部差异

#### 5. `vpn_core::gateway` - 网关功能

- 系统 IP 转发配置
- NAT（MASQUERADE）设置
- 外网接口自动检测
- iptables/pfctl 规则管理

#### 6. `vpn_server` - 服务端

- 会话管理（SessionMap）
- 路由表（PeerMap）
- 握手消息识别与处理
- 身份认证（Ed25519 签名）
- 数据包解密、转发、重新加密
- TUN 设备双向转发（网关模式）

#### 7. `vpn_client` - 客户端

- TUN 设备读写
- 握手流程
- 服务端签名验证
- 上行/下行异步任务
- 平台适配（macOS 4 字节头部）

## 📊 项目进度

| 功能模块 | 状态 | 说明 |
| --- | --- | --- |
| **🌐 网关模式（NAT转发）**   | **✅ 完成** | **互联网代理功能** |
| **🚀 全隧道路由**            | **✅ 完成** | **默认路由支持**   |
| **后量子密钥交换 (ML-KEM-768)** | **✅ 完成** | **抗量子攻击能力** |
| 身份认证 (Ed25519)           | ✅ 完成   | 服务端签名验证     |
| TUN 设备管理                 | ✅ 完成   | 支持 macOS/Linux   |
| 客户端实现                   | ✅ 完成   | 命令行可配置       |
| 服务端实现                   | ✅ 完成   | 多客户端会话管理   |
| 路由学习                     | ✅ 完成   | 握手时自动建立映射 |
| 跨平台支持                   | ✅ 完成   | macOS, Linux       |
| 单元测试                     | ✅ 完成   | 核心模块有测试覆盖 |
| 心跳机制                     | ⚪ 待实现 | 保活和超时检测       |
| 重连机制                     | ⚪ 待实现 | 断线自动重连       |
| NAT 穿透                     | ⚪ 待实现 | UDP 打洞           |
| 配置文件                     | ⚪ 待实现 | TOML/YAML 配置     |
| 分流表 | ⚪ 待实现 | 一个巨大的china_ip库和匹配机制 |

## 🐛 已知问题与限制

1. **密钥轮转**：会话密钥在整个连接期间不变
2. **无重连机制**：网络断开后需要手动重启客户端
3. **日志过多**：调试日志较多，可根据需要精简
4. **单一服务器**：目前不支持服务器集群
5. **握手开销**：ML-KEM 增加了约 2.3 KB 的握手数据量（公钥 1184 字节 + 密文 1088 字节）

### ML-KEM 性能影响

混合密钥交换会带来额外的计算和带宽开销：

| 指标         | 仅 X25519 | X25519 + ML-KEM-768 | 增加量   |
| ------------ | --------- | ------------------- | -------- |
| 握手数据大小 | ~150 字节 | ~2.4 KB             | +2.25 KB |
| 密钥生成时间 | <1 ms     | ~1-2 ms             | +1 ms    |
| 封装/解封装  | <1 ms     | ~1 ms               | +1 ms    |
| 总握手时延   | ~5-10 ms  | ~10-15 ms           | +5 ms    |

**结论**：对于 VPN 握手这种低频操作，ML-KEM 的性能开销完全可以接受，换取的是长期的量子安全保障。

## 📚 依赖库

| 库                  | 版本          | 用途                              |
| ------------------- | ------------- | --------------------------------- |
| tokio               | 1.x           | 异步运行时                        |
| tun                 | 0.6           | TUN 设备创建                      |
| chacha20poly1305    | 0.10          | AEAD 加密                         |
| x25519-dalek        | 2.x           | ECDH 密钥交换                     |
| ed25519-dalek       | 2.x           | 数字签名                          |
| **pqc_kyber** | **0.7** | **后量子密钥封装 (ML-KEM)** |
| blake3              | 1.5           | 密钥派生                          |
| serde + bincode     | 1.x           | 消息序列化                        |
| anyhow              | 1.0           | 错误处理                          |

## 📖 参考资料

### 密码学标准

- [ChaCha20-Poly1305 RFC 8439](https://tools.ietf.org/html/rfc8439)
- [X25519 RFC 7748](https://tools.ietf.org/html/rfc7748)
- [Ed25519 RFC 8032](https://tools.ietf.org/html/rfc8032)
- [ML-KEM (FIPS 203)](https://csrc.nist.gov/pubs/fips/203/final) - NIST 后量子密码标准
- [Kyber Algorithm Specification](https://pq-crystals.org/kyber/) - Kyber 算法官方文档

